image: atlassian/default-image:2

pipelines:
  default:
    - step:
        name: Lint the Dockerfile
        image: hadolint/hadolint:latest-debian
        script:
          - hadolint --ignore DL3008 --ignore DL3022 Dockerfile
          - hadolint --ignore DL3008 --ignore DL3022 **/Dockerfile
    - parallel:
        - step:
            name: Build and Test PHP 7.3
            script:
              - IMAGE_NAME=$BITBUCKET_REPO_SLUG
              - VERSION=7.3
              - IMAGE=${DOCKER_REPOSITORY}/docker/${IMAGE_NAME}
              - docker build . --build-arg PHP_VERSION=${VERSION} --tag "${IMAGE}:${VERSION}"
              - docker build ./development --build-arg PHP_VERSION=${VERSION} --tag "${IMAGE}-dev:${VERSION}"
              - docker build ./production --build-arg PHP_VERSION=${VERSION} --tag "${IMAGE}-prod:${VERSION}"
              - docker save ${IMAGE}:${VERSION} | gzip > "${IMAGE_NAME}-${VERSION}.tar.gz"
              - docker save ${IMAGE}-dev:${VERSION} | gzip > "${IMAGE_NAME}-dev-${VERSION}.tar.gz"
              - docker save ${IMAGE}-prod:${VERSION} | gzip > "${IMAGE_NAME}-prod-${VERSION}.tar.gz"
            services:
              - docker
            caches:
              - docker
            artifacts:
              - "*.tar.gz"
        - step:
            name: Build and Test PHP 7.4
            script:
              - IMAGE_NAME=$BITBUCKET_REPO_SLUG
              - VERSION=7.4
              - IMAGE=${DOCKER_REPOSITORY}/docker/${IMAGE_NAME}
              - docker build . --build-arg PHP_VERSION=${VERSION} --tag "${IMAGE}:${VERSION}"
              - docker build ./development --build-arg PHP_VERSION=${VERSION} --tag "${IMAGE}-dev:${VERSION}"
              - docker build ./production --build-arg PHP_VERSION=${VERSION} --tag "${IMAGE}-prod:${VERSION}"
              - docker save ${IMAGE}:${VERSION} | gzip > "${IMAGE_NAME}-${VERSION}.tar.gz"
              - docker save ${IMAGE}-dev:${VERSION} | gzip > "${IMAGE_NAME}-dev-${VERSION}.tar.gz"
              - docker save ${IMAGE}-prod:${VERSION} | gzip > "${IMAGE_NAME}-prod-${VERSION}.tar.gz"
            services:
              - docker
            caches:
              - docker
            artifacts:
              - "*.tar.gz"
        - step:
            name: Build and Test PHP 8.0
            script:
              - IMAGE_NAME=$BITBUCKET_REPO_SLUG
              - VERSION=8.0
              - IMAGE=${DOCKER_REPOSITORY}/docker/${IMAGE_NAME}
              - docker build . --build-arg PHP_VERSION=${VERSION} --tag "${IMAGE}:${VERSION}"
              - docker build ./development --build-arg PHP_VERSION=${VERSION} --tag "${IMAGE}-dev:${VERSION}"
              - docker build ./production --build-arg PHP_VERSION=${VERSION} --tag "${IMAGE}-prod:${VERSION}"
              - docker save ${IMAGE}:${VERSION} | gzip > "${IMAGE_NAME}-${VERSION}.tar.gz"
              - docker save ${IMAGE}-dev:${VERSION} | gzip > "${IMAGE_NAME}-dev-${VERSION}.tar.gz"
              - docker save ${IMAGE}-prod:${VERSION} | gzip > "${IMAGE_NAME}-prod-${VERSION}.tar.gz"
            services:
              - docker
            caches:
              - docker
            artifacts:
              - "*.tar.gz"
  branches:
    master:
      - parallel:
        - step:
            name: Deploy PHP 7.3
            script:
              - IMAGE_NAME=$BITBUCKET_REPO_SLUG
              - VERSION=7.3
              - IMAGE=${DOCKER_REPOSITORY}/docker/${IMAGE_NAME}
              - docker load < "${IMAGE_NAME}:${VERSION}.tar.gz"
              - docker load < "${IMAGE_NAME}-dev:${VERSION}.tar.gz"
              - docker load < "${IMAGE_NAME}-prod:${VERSION}.tar.gz"
              - echo ${DOCKER_PASSWORD} | docker login ${DOCKER_REPOSITORY} --username "${DOCKER_USERNAME}" --password-stdin
              - docker push "${IMAGE}:${VERSION}"
              - docker push "${IMAGE}-dev:${VERSION}"
              - docker push "${IMAGE}-prod:${VERSION}"
            services:
              - docker
        - step:
            name: Deploy PHP 7.4
            script:
              - IMAGE_NAME=$BITBUCKET_REPO_SLUG
              - VERSION=7.4
              - IMAGE=${DOCKER_REPOSITORY}/docker/${IMAGE_NAME}
              - docker load < "${IMAGE_NAME}:${VERSION}.tar.gz"
              - docker load < "${IMAGE_NAME}-dev:${VERSION}.tar.gz"
              - docker load < "${IMAGE_NAME}-prod:${VERSION}.tar.gz"
              - echo ${DOCKER_PASSWORD} | docker login ${DOCKER_REPOSITORY} --username "${DOCKER_USERNAME}" --password-stdin
              - docker push "${IMAGE}:${VERSION}"
              - docker push "${IMAGE}-dev:${VERSION}"
              - docker push "${IMAGE}-prod:${VERSION}"
            services:
              - docker
        - step:
            name: Deploy PHP 8.0
            script:
              - IMAGE_NAME=$BITBUCKET_REPO_SLUG
              - VERSION=8.0
              - IMAGE=${DOCKER_REPOSITORY}/docker/${IMAGE_NAME}
              - docker load < "${IMAGE_NAME}:${VERSION}.tar.gz"
              - docker load < "${IMAGE_NAME}-dev:${VERSION}.tar.gz"
              - docker load < "${IMAGE_NAME}-prod:${VERSION}.tar.gz"
              - echo ${DOCKER_PASSWORD} | docker login ${DOCKER_REPOSITORY} --username "${DOCKER_USERNAME}" --password-stdin
              - docker push "${IMAGE}:${VERSION}"
              - docker push "${IMAGE}-dev:${VERSION}"
              - docker push "${IMAGE}-prod:${VERSION}"
            services:
              - docker