name: Check for rebuild

on:
  workflow_call:
    inputs:
      version:
        description: 'A php version that should be using to build the image'
        required: true
        type: string
      is-latest:
        description: 'Whether this is the latest PHP version'
        required: false
        type: boolean
        default: false

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      out-of-date: ${{ steps.check.outputs.out-of-date }}
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if update on base image is available
        id: check
        uses: twiddler/is-my-docker-parent-image-out-of-date@v1
        with:
          parent-image: php:${{ inputs.version }}-fpm-alpine
          my-image: ghcr.io/${{ github.repository_owner }}/php-fpm-prod:${{ inputs.version }}

  build:
    name: Production Build and Push
    if: needs.check.outputs.out-of-date == 'true'
    needs: check
    uses: ./.github/workflows/production-build-and-push.yml
    with:
      version: ${{ inputs.version }}
      is-latest: ${{ inputs.is-latest }}
